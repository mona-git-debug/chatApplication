<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat App</title>

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <style>
        body { font-family: Arial; display: flex; height: 100vh; margin: 0; }
        #left { width: 280px; border-right: 1px solid #ccc; padding: 15px; }
        #right { flex: 1; display: flex; flex-direction: column; }
        #messages { flex: 1; padding: 10px; overflow-y: auto; }
        #sendBar { display: flex; padding: 10px; border-top: 1px solid #ccc; }
        #sendBar input { flex: 1; padding: 8px; }
        #sendBar button { padding: 8px 12px; margin-left: 8px; }
        button { padding: 6px 10px; margin-top: 5px; }
        .room { margin-top: 8px; }
        .msg { padding: 6px; margin-bottom: 4px; background: #f1f1f1; border-radius: 5px; }
    </style>
</head>
<body>

<div id="left">

    <h3>Login</h3>

    <input id="username" placeholder="username"><br><br>
    <input id="password" type="password" placeholder="password"><br><br>

    <button onclick="register()">Register</button>
    <button onclick="login()">Login</button>

    <hr>

    <h3>Rooms</h3>
    <div id="rooms"></div>

    <br>
    <input id="newRoom" placeholder="new room name">
    <button onclick="createRoom()">Create Room</button>
</div>

<div id="right">

    <h3 id="currentChat">No Chat Selected</h3>

    <div id="messages"></div>

    <div id="sendBar">
        <input id="msgInput" placeholder="Type a message..." onkeydown="if(event.key==='Enter') sendMessage();">
        <button onclick="sendMessage()">Send</button>
    </div>
</div>

<script>
let stompClient = null;
let token = null;
let currentUser = null;
let currentRecipient = null; // Room name or private user

// ------------------- AUTH -----------------------

function register() {
    sendAuth("/api/auth/register");
}

function login() {
    sendAuth("/api/auth/login");
}

function sendAuth(url) {
    const body = {
        username: document.getElementById('username').value,
        password: document.getElementById('password').value
    };

    fetch(url, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(body)
    })
        .then(r => r.json())
        .then(res => {
            token = res.token;
            currentUser = res.username;
            alert("Logged in as " + currentUser);
            connectWebSocket();
            loadRooms();
        });
}

// ------------------- WEBSOCKET -----------------------

function connectWebSocket() {
    if (stompClient) stompClient.disconnect();

    const socket = new SockJS("/ws");
    stompClient = Stomp.over(socket);

    stompClient.connect({}, function() {
        console.log("Connected WebSocket");

        // Private chat queue
        stompClient.subscribe("/queue/" + currentUser, function(message) {
            showMessage(JSON.parse(message.body), false);
        });

        // Subscribe to ALL rooms (we will filter later)
        stompClient.subscribe("/topic/#", function(message) {
            const msg = JSON.parse(message.body);
            if (msg.recipient === currentRecipient) {
                showMessage(msg, true);
            }
        });
    });
}

// ------------------- ROOMS -----------------------

function loadRooms() {
    fetch("/api/chat/rooms")
        .then(r => r.json())
        .then(rooms => {
            const div = document.getElementById("rooms");
            div.innerHTML = "";

            rooms.forEach(room => {
                const btn = document.createElement("button");
                btn.className = "room";
                btn.innerText = room.name;
                btn.onclick = () => selectRoom(room.name);
                div.appendChild(btn);
                div.appendChild(document.createElement("br"));
            });
        });
}

function createRoom() {
    const name = document.getElementById("newRoom").value;

    fetch("/api/chat/room", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
        },
        body: JSON.stringify({name})
    })
        .then(r => r.json())
        .then(room => {
            alert("Room created: " + room.name);
            loadRooms();
        });
}

function selectRoom(name) {
    currentRecipient = name;
    document.getElementById("currentChat").innerText = "Room: " + name;
    document.getElementById("messages").innerHTML = "";

    fetch("/api/chat/messages/room/" + name)
        .then(r => r.json())
        .then(messages => {
            messages.forEach(m => showMessage({
                sender: m.sender,
                content: m.content
            }, true));
        });
}

// ------------------- SEND MESSAGE -----------------------

function sendMessage() {
    if (!currentRecipient) {
        alert("Select a room first!");
        return;
    }

    const text = document.getElementById("msgInput").value;
    if (text.trim() === "") return;

    const msg = {
        sender: currentUser,
        recipient: currentRecipient,
        content: text,
        roomMessage: true
    };

    stompClient.send("/app/chat.send", {}, JSON.stringify(msg));

    document.getElementById("msgInput").value = "";
}

// ------------------- DISPLAY MESSAGE -----------------------

function showMessage(msg, isRoom) {
    const div = document.getElementById("messages");
    const el = document.createElement("div");
    el.className = "msg";

    el.textContent = msg.sender + ": " + msg.content;

    div.appendChild(el);
    div.scrollTop = div.scrollHeight;
}
</script>

</body>
</html>
